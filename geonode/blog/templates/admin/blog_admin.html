{% extends "site_base.html" %}
{% load i18n %}
{% load dialogos_tags %}
{% load pinax_ratings_tags %}
{% load bootstrap_tags %}

{% load base_tags %}
{% load guardian_tags %}

{% block title %}Blog{% endblock %}

{% block head %}
{{ block.super }}

<link href="{{ STATIC_URL }}idegeo/bootstrap/bootstrap-responsive.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
<link href="{{ STATIC_URL }}idegeo/blog/css/admin_style.css" rel="stylesheet" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
{% endblock %}
{% block body_class %}blog{% endblock %}
{% block middle %}
{% block body_outer %}
{% endblock %}
<div id="page-header" class="content">
  <div class="container">
    <div class="titulo-blk-row">
      <div class="titulo-img blk-cell"><img src="{{STATIC_URL}}idegeo/carousel/images/ico11_capas.png" alt=""></div>
        <div class="titulo-txt blk-cell">
          <h2>Blog</h2>
        </div>
    </div>
  </div>
</div>
<div class="container">
    <div class="btn-group">
        <button type="button" class="btn btn-primary">Referencias</button>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a href="{% url 'reference_add' %}">Crear</a></li>
            <li><a href="{% url 'references_admin' %}">Administrar</a></li>
        </ul>
    </div>
    <h3>Historias y Ligas {% if topic %} del tema {{topic}} {% endif %}</h3>
    <div class="btn-group">
        <button type="button" class="btn btn-primary">Crear</button>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a href="{% url 'blog_post_add' %}?topic_id={{topic.id}}">Entrada</a></li>
            <li><a href="{% url 'blog_link_add' %}?topic_id={{topic.id}}">Link</a></li>
        </ul>
    </div>
    <table id="tabla"
           data-toggle="table"
           data-toolbar="#toolbar"
           data-search="true"
           data-minimum-count-columns="2"
           data-pagination="true"
           data-id-field="id"
           data-page-list="[10, 25, 50, 100, ALL]"
           data-show-footer="false"
           data-response-handler="responseHandler">
        <thead>
        <tr>
            <th>Título</th>
            <th data-filter-control="select">Formato</th>
            <th>Previsualización</th>
            <th>Activo</th>
            <th>Destacado</th>
            <th>Eliminar</th>
        </tr>
        </thead>
        <tbody>
            {% for post in posts %}
            <tr id="tr-id-{{post.id}}" class="tr-class-{{post.id}}" data-title="bootstrap table">
                <td id="td-id-{{post.id}}" class="td-class-{{post.id}}" data-title="bootstrap table">
                    <a href="{% if post.format == 'link' %}{% url 'blog_link_edit' post.id %}{% else %}{% url 'blog_post_edit' post.id %}{% endif %}">{{post}}</a>
                </td>
                <td data-text="526">{% if post.format == 'link' %}Liga{% else %}Historia{% endif %}</td>
                <td>
                    <a href="{% url 'blog_post' post.slug %}" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i></a>
                </td>
                <td data-text="122">{% if post.active %}<i class="fa fa-check" aria-hidden="true"></i>{% else %}<i class="fa fa-times" aria-hidden="true"></i>{% endif %}</td>
                <td data-text="122">{% if post.fix_index %}<i class="fa fa-check" aria-hidden="true"></i>{% else %}<i class="fa fa-times" aria-hidden="true"></i>{% endif %}</td>
                <td>
                    <a href="{% url 'blog_post_remove' post.id %}"><i class="fa fa-trash" aria-hidden="true"></i></a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3>{% if topic %}Sub-Temas de {{topic}} {% else %}Temas{% endif %}</h3>
    <div class="btn-group">
        <button type="button" class="btn btn-primary">Crear</button>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a href="{% url 'blog_topic_add' %}?topic_id={{topic.id}}">Tema</a></li>
        </ul>
    </div>
    <table id="tabla2"
           data-toggle="table"
           data-toolbar="#toolbar"
           data-search="true"
           data-minimum-count-columns="2"
           data-pagination="true"
           data-id-field="id"
           data-page-list="[10, 25, 50, 100, ALL]"
           data-show-footer="false"
           data-response-handler="responseHandler">
        <thead>
        <tr>
            <th>Título</th>
            <th>Sub-Temas</th>
            <th>Previsualización</th>
            <th>Activo</th>
            <th>Eliminar</th>
        </tr>
        </thead>
        <tbody class="topics">
            {% for topic in topics %}
            <tr id="{{topic.id}}" class="topic tr-class-{{topic.id}}" data-title="bootstrap table">
                <td id="td-id-{{topic.id}}" class="td-class-{{topic.id}}" data-title="bootstrap table">
                    <a href="{% url 'blog_topic_edit' topic.id %}">{{topic}}</a>
                </td>
                <td data-text="526">
                    <div class="btn-group">
                        <a href="{% url 'blog_topic_admin' topic.id %}" class="btn btn-primary">Administrar</a>
                    </div>
                </td>
                <td>
                    {% if topic.slug %}
                        <a href="{% url 'blog_topic_detail' topic.slug %}" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i></a>
                    {% endif %}
                </td>
                <td data-text="122">{% if topic.active %}<i class="fa fa-check" aria-hidden="true"></i>{% else %}<i class="fa fa-times" aria-hidden="true"></i>{% endif %}</td>
                <td>
                    <a href="{% url 'blog_topic_remove' topic.id %}"><i class="fa fa-trash" aria-hidden="true"></i></a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_script %}
<script>
    /* Sort Topic */
    $(function() {
        $(".topics").sortable({
            tolerance: 'pointer',
            revert: 'invalid',
            items: "> tr.topic",
            placeholder: 'placeholder',
            forcePlaceholderSize: true,
            forceHelperSize: true,
            axis: "y",
            //cancel: ".top-tools, .top-exp",
            cursor: "row-resize",
            stop: function(event, ui) {
                var sortedIDs = $(this).sortable('toArray');
                $.ajax({
                    url: '{% url "blog_sort_topic" %}',
                    type: 'POST',
                    data: {
                        'sorted_ids': JSON.stringify(sortedIDs),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    error: function(xhr, errmsg, err) {
                        console.log('Error en el servidor')
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                });
            }
        });
    });
    /* Sort subTopic */
    $(function() {
        $(".subtopics").sortable({
            tolerance: 'pointer',
            revert: 'invalid',
            items: "tr.subtopics",
            placeholder: 'placeholder',
            forcePlaceholderSize: true,
            forceHelperSize: true,
            axis: "y",
            //cancel: ".top-tools, .top-exp",
            cursor: "row-resize",
            stop: function(event, ui) {
                var sortedIDs = $(this).sortable('toArray');
                $.ajax({
                    url: '{% url "blog_sort_topic" %}',
                    type: 'POST',
                    data: {
                        'sorted_ids': JSON.stringify(sortedIDs),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    error: function(xhr, errmsg, err) {
                        console.log('Error en el servidor')
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                });
            }
        });
    });
</script>
{% endblock extra_script %}