{% extends "mviewer_base.html" %}
{% load i18n %}
{% load bootstrap_tags %}

{% block title %} Metadato de Visualizador {% endblock %}

{% block head %}
  {{ block.super }}
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
  integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
  crossorigin=""/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.0/esri-leaflet-geocoder.css">
<link rel="stylesheet" href="{{STATIC_URL}}idegeo/mviewer/css/dd.css" />

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>-->
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet-src.js"
  integrity="sha512-+ZaXMZ7sjFMiCigvm8WjllFy6g3aou3+GZngAtugLzrmPFKFK7yjSri0XnElvCTu/PrifAYQuxZTybAEkA8VOA=="
  crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.0/esri-leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.0/esri-leaflet-geocoder.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6ZJwb2cqgW1YXsmXGT1I-0ujia5UREAg&libraries=places" async defer></script>
<script src='https://unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js'></script>
<style>
#map, #second {
  height: 480px;
}

#id_bbox_x0, #id_bbox_y0, #id_bbox_x1, #id_bbox_y1 {
  width: 180px;
}
</style>
{% endblock %}
{% block page_header %}
<div id="page-header" class="content">
  <div class="container">
    <div class="titulo-blk-row">
      <div class="titulo-img blk-cell"><img src="{{STATIC_URL}}idegeo/carousel/images/ico11_capas.png" alt=""></div>
        <div class="titulo-txt blk-cell">
          <h2>Metadato del Panorama</h2>
        </div>
    </div>
  </div>
</div>
{% endblock %}
{% block body_outer %}
<div class="container">
    {% if mv.id %}
    <div class="project-title clearfix">
          <span class="ms-close-detail">
               <font size="+3"><a href="{% url 'mviewer_list' %}"><i class="fa fa-chevron-left" title="Regresar a Panoramas"></i></a></font>
          </span>
          <h3 align="center" title="{{mv.name}}">{{mv.name|truncatechars:55}}
            <a href="{% url 'microviewer' mv.url_id %}" target="_blank"><i class="fa fa-arrow-circle-right" title="Ir a"></i></a>
          </h3>
          <span class="close_ms">
            <font size="+3"><a href="{% url 'mviewer_detail' mv.id %}"><i class="fa fa-cog" title="Configurar Panorama"></i></a></font>
          </span>
    </div>
    {% endif %}
  </div>
<div class="container">
	<div class="cont_meta">
		<div class="col-md-8" id="general">
			<form id="formulario" method="post" enctype="multipart/form-data" action="">{% csrf_token %}
				{{ form.media }}
				{{form|as_bootstrap}}
				<label>Ajuste el mapa para definir el BBOX</label>
				<div style="margin-bottom:10px;">Mapa Base:<select id="basemaps" style="margin-left:50px;"></select></div>
				<div id="map"></div></br>
        <input id="id_limited_zoom" type="checkbox" name="limited_zoom"> Activar para restringir Zoom</br>
        <div id="second"></div><br>
				<p><a href="{% url 'mviewer_list' %}" class="btn btn-primary">Regresar</a> <input type="submit" class="btn btn-primary pull-right" value="Guardar y Avanzar"></p></br>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_script %}
<script>{% include "basemap.js" %}</script>
<script>{% include "tileMapsLayers.js" %}</script>

<!--menu de logos-->
<script language="javascript">
$(document).ready(function(e) {
try {
$("#webmenu").msDropDown('2');
} catch(e) {
alert(e.message);
}
});
</script>

<script src="{{STATIC_URL}}idegeo/mviewer/js/dd.min.js" type="text/javascript"></script>

<script type="text/javascript">
$('#div_id_config').hide();
$('#div_id_bbox_x0').css('float', 'left');
$('#div_id_bbox_y0').css('float', 'left');
$('#div_id_bbox_x1').css('float', 'left');

$('#div_id_is_public').css('border-bottom','1px dotted #4b8865');
$('#div_id_is_public').css('padding-bottom','0px');
$('#div_id_no_topics').prepend('<p>Preferencias de Interfaz</p>');
$('#div_id_icon_title').prepend('<p>Preferencias de Interfaz</p>');

/* Fill select with basemaps */
$.each(basemapsDict, function(k, v){
  $("#basemaps").append('<option value="'+ k +'">'+ v[1] +'</option>');
});

var baseMap, secondMap;
if($('#id_config').val()!='' && $('#id_config').val() in basemapsDict) {
  baseMap = basemapsDict[$('#id_config').val()][0];
  secondMap = basemapsDict_2[$('#id_config').val()][0];
	$("#basemaps").val($('#id_config').val());
} else {
  baseMap = Stamen_TerrainBackground;
  secondMap = Stamen_TerrainBackground_2;
	$("#basemaps").val('stamenTerrain');
}

var southWest = L.latLng(-90, -180),
      northEast = L.latLng(90, 180),
      bounds = L.latLngBounds(southWest, northEast);

var map = L.map('map', {
        center: [24, -101],
        zoom: 5,
        animate: true,
        layers: [baseMap],
        maxBounds: bounds,
        maxZoom: 18, 
        //minZoom: 3
      });


var second = L.map('second', {
  center: [24, -101],
  zoom: 5,
  animate: true,
  layers: [secondMap],
  maxBounds: bounds,
  maxZoom: 16, 
  //minZoom: 3
});

$("#basemaps").change(function () {
  basemapsDict[this.value][0].addTo(map);
  basemapsDict_2[this.value][0].addTo(second);
  map.removeLayer(baseMap);
  second.removeLayer(secondMap);
  baseMap = basemapsDict[this.value][0];
  secondMap = basemapsDict_2[this.value][0];
  $('#id_config').val(this.value);
});

let tema = document.getElementById("id_template_style").value

document.getElementById("div_id_icon_title").style.display="none";
document.getElementById("div_id_no_topics").style.display="none";
document.getElementById("div_id_is_vertical").style.display="none";

function template_choose() {
  if (tema == "Original_1") {
    document.getElementById("id_no_topics").checked = false;
    document.getElementById("id_icon_title").checked = false;
  } else if (tema == "Original_2") {
    document.getElementById("id_no_topics").checked = true;
    document.getElementById("id_icon_title").checked = false;
  } else if (tema == "Alternativo_1" || tema == "Alternativo_3") {
    document.getElementById("id_no_topics").checked = false;
    document.getElementById("id_icon_title").checked = true;
  } else if (tema == "Alternativo_2" || tema == "Alternativo_4") {
    document.getElementById("id_no_topics").checked = false;
    document.getElementById("id_icon_title").checked = false;
  }
}



$('#id_template_style').change(function() {
  tema = document.getElementById("id_template_style").value
  template_choose()
});

var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider();

var searchControl = L.esri.Geocoding.geosearch({
	providers: [arcgisOnline]
	}).addTo(map);

var results = L.layerGroup().addTo(map);

var searchControl = L.esri.Geocoding.geosearch({
	providers: [arcgisOnline]
	}).addTo(second);

var results = L.layerGroup().addTo(second);

var mviewer = {{mviewer|safe}};

if (mviewer.limited_zoom) { $('#id_limited_zoom').prop('checked', true) }

if (mviewer.bbox_x0 != 'a') {
	var bounds = [
    [mviewer.bbox_y0, mviewer.bbox_x0],
     [mviewer.bbox_y1, mviewer.bbox_x1]
  	];
  map.fitBounds(bounds);
} else {
	set_bbox();
  set_limitZoom();
}

map.on('moveend', function() {
     set_bbox();
});

second.on('moveend', function() {
     set_limitZoom();
});

function set_bbox () {
	 var bbox = map.getBounds();
	 $('#id_bbox_x0').val(Math.round(bbox._northEast.lng*10000000)/10000000);
	 $('#id_bbox_y0').val(Math.round(bbox._northEast.lat*10000000)/10000000);
	 $('#id_bbox_x1').val(Math.round(bbox._southWest.lng*10000000)/10000000);
	 $('#id_bbox_y1').val(Math.round(bbox._southWest.lat*10000000)/10000000);
}

function set_limitZoom(){
  var set_limitZoom = second.getZoom();
  $('#id_custome_zoom').val(set_limitZoom);
  
}
$('#div_id_custome_zoom').css('display', 'none');
let check = document.getElementById('id_no_topics');
let check2 = document.getElementById('id_is_vertical');
$('input[type="checkbox"]').on('click', function(){
    if(this.id == "id_no_topics") {
      if (this.checked) {
        $(check2).prop('disabled',true);
      } else {
        $(check2).prop('disabled',false);
      }
    }else if(this.id == "id_is_vertical") {
        if (this.checked) {
        $(check).prop('disabled',true);
      } else {
        $(check).prop('disabled',false);
      }
    }
})
function activeZommMap() {
  if($('#id_limited_zoom').is(':checked')){
    $('#second').show()
  } else {
    $('#second').hide()
  }
  var customeZoom =[mviewer.custome_zoom];
  var secondBounds = [
    [mviewer.bbox_y0, mviewer.bbox_x0],
    [mviewer.bbox_y1, mviewer.bbox_x1]
  	];
  second.fitBounds(secondBounds);
  second.setZoom(customeZoom);
}
activeZommMap();
$('#id_limited_zoom').on('click', activeZommMap)
<!--// Set logo inicial-->
<!--$("#webmenu").val(mviewer.logo);-->
<!--</script>-->
<!--{% endblock extra_script %}-->